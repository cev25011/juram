<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ê°€ìœ„ë°”ìœ„ë³´ ë¡œë´‡</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1e1e2e; color: white; margin: 0; padding: 20px; }
        #video-container { position: relative; display: inline-block; margin-top: 20px; }
        canvas { transform: scaleX(-1); border: 4px solid #f5c2e7; border-radius: 15px; width: 100%; max-width: 640px; }
        .controls { margin-bottom: 20px; }
        button { padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 10px; border: none; margin: 5px; transition: 0.3s; }
        .btn-connect { background: #fab387; color: #11111b; }
        .btn-play { background: #a6e3a1; color: #11111b; }
        button:hover { opacity: 0.8; transform: scale(1.05); }
        #status { font-size: 22px; margin: 15px; height: 30px; color: #89b4fa; }
    </style>
</head>
<body>
    <h1>AI ê°€ìœ„ë°”ìœ„ë³´ vs ì•„ë‘ì´ë…¸</h1>
    
    <div class="controls">
        <button class="btn-connect" onclick="connectSerial()">1. ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</button>
        <button class="btn-play" onclick="playGame()">2. ê°€ìœ„ë°”ìœ„ë³´!</button>
    </div>

    <div id="status">ì¹´ë©”ë¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    
    <div id="video-container">
        <video id="video" autoplay playsinline style="display:none;"></video>
        <canvas id="canvas"></canvas>
    </div>

    <script>
        let port, writer, detector;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status');

        // 1. ì¹´ë©”ë¼ ë° AI ì´ˆê¸°í™”
        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                const model = handPoseDetection.SupportedModels.MediaPipeHands;
                detector = await handPoseDetection.createDetector(model, {
                    runtime: 'mediapipe',
                    solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands'
                });
                
                statusText.innerText = "ì¤€ë¹„ ì™„ë£Œ! ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ ì—°ê²°í•´ ì£¼ì„¸ìš”.";
                draw();
            } catch (err) {
                statusText.innerText = "ì˜¤ë¥˜: ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        function draw() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            requestAnimationFrame(draw);
        }

        // 2. ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° (Web Serial API)
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                writer = port.writable.getWriter();
                statusText.innerText = "ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì„±ê³µ! ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.";
            } catch (err) {
                statusText.innerText = "ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì‹¤íŒ¨: " + err.message;
            }
        }

        // 3. ê²Œì„ ì‹¤í–‰
        async function playGame() {
            if (!detector) return;
            statusText.innerText = "ê°€ìœ„... ë°”ìœ„... ë³´!!!";
            
            setTimeout(async () => {
                const hands = await detector.estimateHands(video);
                if (hands.length > 0) {
                    const playerMove = getMove(hands[0].keypoints);
                    const moves = ["Rock", "Scissors", "Paper"];
                    const aiMove = moves[Math.floor(Math.random() * 3)];
                    
                    let result = "";
                    let arduinoCmd = "";

                    // ìŠ¹íŒ¨ ë¡œì§ (ì‚¬ìš©ìê°€ ì§€ëŠ” ê²½ìš°)
                    if ((playerMove === "Rock" && aiMove === "Paper") || 
                        (playerMove === "Scissors" && aiMove === "Rock") || 
                        (playerMove === "Paper" && aiMove === "Scissors")) {
                        result = `ì¡ŒìŠµë‹ˆë‹¤! ğŸ˜­ (AI: ${trans(aiMove)})`;
                        arduinoCmd = 'L'; // ì•„ë‘ì´ë…¸ë¡œ ë³´ë‚¼ ì‹ í˜¸
                    } else if (playerMove === aiMove) {
                        result = `ë¹„ê²¼ìŠµë‹ˆë‹¤! ğŸ˜ (AI: ${trans(aiMove)})`;
                    } else {
                        result = `ì´ê²¼ìŠµë‹ˆë‹¤! ğŸ˜ (AI: ${trans(aiMove)})`;
                    }

                    statusText.innerText = result;
                    if (arduinoCmd === 'L' && writer) {
                        await writer.write(new TextEncoder().encode('L'));
                    }
                } else {
                    statusText.innerText = "ì†ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤!";
                }
            }, 1000); // 1ì´ˆ ë’¤ ì¸ì‹
        }

        function getMove(keypoints) {
            const tips = [8, 12
