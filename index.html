<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ê°€ìœ„ë°”ìœ„ë³´ ë§ì¹˜ ê²Œì„ (Bluetooth)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        body { text-align: center; font-family: 'Malgun Gothic', sans-serif; background: #222; color: white; }
        .container { position: relative; display: inline-block; }
        canvas { background: #000; border-radius: 15px; width: 100%; max-width: 640px; transform: rotateY(180deg); }
        .info { margin: 20px; padding: 20px; background: #333; border-radius: 10px; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 5px; color: white; transition: 0.3s; margin: 5px; }
        #btn-bt { background: #3498db; } /* ë¸”ë£¨íˆ¬ìŠ¤ ë²„íŠ¼ ìƒ‰ìƒ */
        #btn-game { background: #2ecc71; }
        button:hover { opacity: 0.8; }
        #status { color: #f1c40f; margin-top: 10px; }
        #result-display { font-size: 40px; font-weight: bold; margin-top: 15px; color: #ff4757; }
    </style>
</head>
<body>
    <h1>âœŠâœŒï¸âœ‹ AI ë¸”ë£¨íˆ¬ìŠ¤ ë§ì¹˜ ê²Œì„</h1>
    
    <div class="container">
        <canvas class="output_canvas"></canvas>
        <video class="input_video" style="display:none;"></video>
    </div>

    <div class="info">
        <button id="btn-bt">1. ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</button>
        <button id="btn-game">2. ê²Œì„ ì‹œì‘!</button>
        <div id="status">ì¹´ë©”ë¼ ë¡œë”© ì¤‘...</div>
        <div id="result-display">ì¤€ë¹„í•˜ì„¸ìš”!</div>
    </div>

    <script>
        const videoElement = document.querySelector('.input_video');
        const canvasElement = document.querySelector('.output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusText = document.getElementById('status');
        const resultText = document.getElementById('result-display');
        
        let bluetoothCharacteristic; // ë¸”ë£¨íˆ¬ìŠ¤ íŠ¹ì„± ì €ì¥
        let currentGesture = "";

        // 1. ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° (Web Bluetooth API)
        document.getElementById('btn-bt').onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'HC' }], // ëª¨ë“ˆ ì´ë¦„ì— ë”°ë¼ ìˆ˜ì • (ì˜ˆ: HC-06)
                    optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb'] // HM-10/HC-05 í‘œì¤€ ì„œë¹„ìŠ¤ UUID
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
                bluetoothCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
                
                statusText.innerText = "âœ… ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì™„ë£Œ!";
            } catch (err) {
                console.error(err);
                statusText.innerText = "âŒ ì—°ê²° ì‹¤íŒ¨: " + err;
            }
        };

        // 2. ë¸”ë£¨íˆ¬ìŠ¤ë¡œ 'H' ì‹ í˜¸ ë³´ë‚´ê¸°
        async function hitHammer() {
            if (bluetoothCharacteristic) {
                const encoder = new TextEncoder();
                await bluetoothCharacteristic.writeValue(encoder.encode('H')); // 'H' ì „ì†¡
            }
        }

        // 3. ê°€ìœ„ë°”ìœ„ë³´ íŒì • ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});

                const indexOpen = landmarks[8].y < landmarks[6].y;
                const middleOpen = landmarks[12].y < landmarks[10].y;
                const ringOpen = landmarks[16].y < landmarks[14].y;
                const pinkyOpen = landmarks[20].y < landmarks[18].y;

                if (indexOpen && middleOpen && ringOpen && pinkyOpen) currentGesture = "ë³´";
                else if (indexOpen && middleOpen && !ringOpen) currentGesture = "ê°€ìœ„";
                else if (!indexOpen && !middleOpen && !ringOpen && !pinkyOpen) currentGesture = "ë°”ìœ„";
                
                statusText.innerText = "ê°ì§€ëœ ì†: " + currentGesture;
            }
            canvasCtx.restore();
        }

        // 4. ê²Œì„ ì§„í–‰ (ê¸°ì¡´ ìœ ì§€)
        document.getElementById('btn-game').onclick = () => {
            if (!currentGesture) {
                alert("ì¹´ë©”ë¼ì— ì†ì„ ë³´ì—¬ì£¼ì„¸ìš”!");
                return;
            }
            const rps = ["ê°€ìœ„", "ë°”ìœ„", "ë³´"];
            const computer = rps[Math.floor(Math.random() * 3)];
            
            if (currentGesture === computer) {
                resultText.innerText = `ë¬´ìŠ¹ë¶€! (ì»´í“¨í„°: ${computer})`;
            } else if (
                (currentGesture === "ê°€ìœ„" && computer === "ë°”ìœ„") ||
                (currentGesture === "ë°”ìœ„" && computer === "ë³´") ||
                (currentGesture === "ë³´" && computer === "ê°€ìœ„")
            ) {
                resultText.innerText = `íŒ¨ë°°! ğŸ”¨ (ì»´í“¨í„°: ${computer})`;
                hitHammer(); 
            } else {
                resultText.innerText = `ìŠ¹ë¦¬! ğŸ‰ (ì»´í“¨í„°: ${computer})`;
            }
        };

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>
