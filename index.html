<!DOCTYPE html>
<html>
<head>
    <title>AI 가위바위보 - 아두이노 연동</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/models/hand-pose-detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
        canvas { transform: scaleX(-1); border: 2px solid #333; border-radius: 10px; }
        .controls { margin: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #status { font-size: 24px; font-weight: bold; color: #ff4757; }
    </style>
</head>
<body>
    <h1>AI 가위바위보 (Bluetooth)</h1>
    <div class="controls">
        <button onclick="connectSerial()">1. 블루투스 연결</button>
        <button onclick="playGame()">2. 가위바위보!</button>
    </div>
    <div id="status">연결 버튼을 눌러주세요</div>
    <div style="position: relative; display: inline-block;">
        <video id="video" width="640" height="480" autoplay playsinline style="display:none;"></video>
        <canvas id="canvas"></canvas>
    </div>

    <script>
        let port;
        let writer;
        let detector;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 1. Web Serial API를 이용한 블루투스 연결
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                writer = port.writable.getWriter();
                document.getElementById('status').innerText = "블루투스 연결 성공!";
            } catch (err) {
                console.error(err);
                alert("연결에 실패했습니다.");
            }
        }

        // 2. AI 모델 로드 및 카메라 설정
        async function setupAI() {
            const model = handPoseDetection.SupportedModels.MediaPipeHands;
            detector = await handPoseDetection.createDetector(model, {
                runtime: 'mediapipe',
                solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands'
            });
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                draw();
            };
        }

        async function draw() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            requestAnimationFrame(draw);
        }

        // 3. 가위바위보 게임 로직
        async function playGame() {
            if (!detector) return;
            document.getElementById('status').innerText = "결과 계산 중...";
            
            const hands = await detector.estimateHands(video);
            if (hands.length > 0) {
                const move = getMove(hands[0].keypoints);
                const aiMoves = ["Rock", "Scissors", "Paper"];
                const aiMove = aiMoves[Math.floor(Math.random() * 3)];
                
                let result = "";
                // 승패 판단 (사용자가 지는 경우 체크)
                if ((move === "Rock" && aiMove === "Paper") || 
                    (move === "Scissors" && aiMove === "Rock") || 
                    (move === "Paper" && aiMove === "Scissors")) {
                    result = `AI 승리! (${aiMove} vs ${move})`;
                    sendToArduino('L'); // 아두이노에 'L' 전송
                } else if (move === aiMove) {
                    result = `비겼습니다! (${aiMove})`;
                } else {
                    result = `당신이 이겼습니다! (${aiMove} vs ${move})`;
                }
                document.getElementById('status').innerText = result;
            } else {
                document.getElementById('status').innerText = "손이 보이지 않아요!";
            }
        }

        function getMove(keypoints) {
            // 단순화된 로직: 손가락 끝점의 높이로 판단
            const tips = [8, 12, 16, 20]; // 검지, 중지, 약지, 소지
            let upCount = 0;
            tips.forEach(idx => {
                if (keypoints[idx].y < keypoints[idx-2].y) upCount++;
            });
            if (upCount <= 1) return "Rock";
            if (upCount >= 4) return "Paper";
            return "Scissors";
        }

        async function sendToArduino(char) {
            if (writer) {
                const data = new TextEncoder().encode(char);
                await writer.write(data);
            }
        }

        setupAI();
    </script>
</body>
</html>
